name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.set_version.outputs.release_version }}
      js_changed: ${{ steps.detect_changes.outputs.js_changed }}
      py_changed: ${{ steps.detect_changes.outputs.py_changed }}
      php_changed: ${{ steps.detect_changes.outputs.php_changed }}
      go_changed: ${{ steps.detect_changes.outputs.go_changed }}
      ruby_changed: ${{ steps.detect_changes.outputs.ruby_changed }}
      java_changed: ${{ steps.detect_changes.outputs.java_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive release version from tag
        id: set_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            ver=${GITHUB_REF#refs/tags/}
            ver=${ver#v}
          else
            ver=$(date +%s)
          fi
          echo "release_version=$ver" >> $GITHUB_OUTPUT
          echo "Derived release version: $ver"

      - name: Detect changed packages
        id: detect_changes
        run: |
          git fetch --tags --quiet || true
          
          # Get the current tag
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "Current tag: $CURRENT_TAG"
          
          # Get the commit for the current tag
          CURRENT_COMMIT=$(git rev-list -n 1 "$CURRENT_TAG" 2>/dev/null || echo "HEAD")
          echo "Current commit: $CURRENT_COMMIT"
          
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_COMMIT}^" 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          
          # Detect changes by comparing folders
          if [ -n "$PREV_TAG" ]; then
            echo "Comparing $PREV_TAG to $CURRENT_COMMIT"
            CHANGED=$(git diff --name-only "$PREV_TAG" "$CURRENT_COMMIT" || true)
          else
            # No previous tag, mark all as changed
            echo "No previous tag found, marking all SDKs as changed"
            CHANGED=$(git ls-tree -r --name-only "$CURRENT_COMMIT" || git ls-tree -r --name-only HEAD || true)
          fi
          
          echo "Changed files:"
          echo "$CHANGED"
          
          js=false; py=false; php=false; go=false; ruby=false; java=false
          if echo "$CHANGED" | grep -E '^js/' >/dev/null 2>&1; then js=true; fi
          if echo "$CHANGED" | grep -E '^python/' >/dev/null 2>&1; then py=true; fi
          if echo "$CHANGED" | grep -E '^php/' >/dev/null 2>&1; then php=true; fi
          if echo "$CHANGED" | grep -E '^go/' >/dev/null 2>&1; then go=true; fi
          if echo "$CHANGED" | grep -E '^ruby/' >/dev/null 2>&1; then ruby=true; fi
          if echo "$CHANGED" | grep -E '^java/' >/dev/null 2>&1; then java=true; fi
          
          echo "js_changed=$js" >> $GITHUB_OUTPUT
          echo "py_changed=$py" >> $GITHUB_OUTPUT
          echo "php_changed=$php" >> $GITHUB_OUTPUT
          echo "go_changed=$go" >> $GITHUB_OUTPUT
          echo "ruby_changed=$ruby" >> $GITHUB_OUTPUT
          echo "java_changed=$java" >> $GITHUB_OUTPUT
          echo "Detected changes: JS=$js, Python=$py, PHP=$php, Go=$go, Ruby=$ruby, Java=$java"

  release-js:
    needs: prepare
    if: needs.prepare.outputs.js_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          scope: '@festivo-io'

      - name: Sync version
        run: |
          node -e "const fs=require('fs'); const p=require('./js/package.json'); p.version='${{ needs.prepare.outputs.release_version }}'; fs.writeFileSync('./js/package.json', JSON.stringify(p,null,2));"

      - name: Check npm for version
        id: npm_check
        run: |
          cd js
          ver=$(node -p "require('./package.json').version")
          echo "Checking npm for @festivo-io/festivo-sdk@$ver"
          if npm view @festivo-io/festivo-sdk@$ver >/dev/null 2>&1; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "Version $ver is already published, will skip publish step."
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "Version $ver not found on npm, publish will proceed."
          fi

      - name: Test JS/TS SDK
        run: |
          cd js
          npm ci || npm install
          npm run test

      - name: Publish JS package
        if: "startsWith(github.ref, 'refs/tags/v') && steps.npm_check.outputs.version_exists != 'true'"
        run: |
          cd js
          npm run build || true
          npm publish --access public --registry https://registry.npmjs.org
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release-python:
    needs: prepare
    if: needs.prepare.outputs.py_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Sync version
        run: |
          sed -E -i.bak "s/^version\s*=\s*\"[^\"]*\"/version = \"${{ needs.prepare.outputs.release_version }}\"/" python/pyproject.toml

      - name: Setup Python and Poetry
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          python -m pip install poetry

      - name: Test Python SDK
        run: |
          cd python
          poetry install
          poetry run pytest

      - name: Check PyPI for version
        id: pypi_check
        run: |
          cd python
          ver=$(sed -nE 's/^version *= *"([^"]+)"/\1/p' pyproject.toml | head -n1)
          name=$(sed -nE 's/^name *= *"([^"]+)"/\1/p' pyproject.toml | head -n1)
          echo "Checking PyPI for ${name} version ${ver}"
          if curl -sSf "https://pypi.org/pypi/${name}/json" >/dev/null 2>&1; then
            if curl -s "https://pypi.org/pypi/${name}/json" | python -c "import sys,json; d=json.load(sys.stdin); print('true' if '${ver}' in d.get('releases',{}) else 'false')" | grep -q true; then
              echo "version_exists=true" >> $GITHUB_OUTPUT
              echo "Version ${ver} already on PyPI"
            else
              echo "version_exists=false" >> $GITHUB_OUTPUT
              echo "Version ${ver} not on PyPI"
            fi
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "Package ${name} not found on PyPI"
          fi

      - name: Publish Python package
        if: "startsWith(github.ref, 'refs/tags/v') && steps.pypi_check.outputs.version_exists != 'true'"
        run: |
          cd python
          poetry build
          poetry publish --username __token__ --password "$PYPI_API_TOKEN"
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

  release-php:
    needs: prepare
    if: needs.prepare.outputs.php_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Sync version
        run: |
          sed -E -i.bak "s/\"version\"\s*:\s*\"[^\"]*\"/\"version\": \"${{ needs.prepare.outputs.release_version }}\"/" php/composer.json

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Test PHP SDK
        run: |
          cd php
          composer install --no-interaction
          composer test

      - name: Publish PHP / Packagist
        if: startsWith(github.ref, 'refs/tags/v')
        run: echo "Packagist publishing is handled via Packagist/GitHub integration."

      - name: Notify Packagist
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          PACKAGIST_USER: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_API_TOKEN }}
        run: |
          if [ -z "$PACKAGIST_USER" ] || [ -z "$PACKAGIST_TOKEN" ]; then
            echo "Packagist credentials not provided; skipping notify."
            exit 0
          fi
          echo "Notifying Packagist to update package festivo-io/festivo-php"
          curl -sS -X POST "https://packagist.org/api/update-package?username=${PACKAGIST_USER}&apiToken=${PACKAGIST_TOKEN}" -d "package=festivo-io/festivo-php" || true

  release-go:
    needs: prepare
    if: needs.prepare.outputs.go_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Test Go SDK
        run: |
          cd go
          go test -v ./...

      - name: Go modules published
        if: startsWith(github.ref, 'refs/tags/v')
        run: echo "Go modules are available via git tags."

  release-ruby:
    needs: prepare
    if: needs.prepare.outputs.ruby_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Build Ruby gem
        run: |
          cd ruby
          gem build festivo.gemspec

      - name: Test Ruby gem
        run: |
          cd ruby
          # Add test command if available, e.g. rspec or minitest
          echo "No tests defined for Ruby gem."

      - name: Publish Ruby gem
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          cd ruby
          gem push festivo-*.gem --key rubygems --host https://rubygems.org
        env:
          GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}

  release-java:
    needs: prepare
    if: needs.prepare.outputs.java_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          gpg-private-key: ${{ secrets.JAVA_GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.JAVA_GPG_PASSPHRASE }}

      - name: Build Java SDK
        run: |
          cd java
          ./gradlew build || mvn package

      - name: Test Java SDK
        run: |
          cd java
          ./gradlew test || mvn test

      - name: Publish to Maven Central (Sonatype)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          cd java
          ./gradlew publish || mvn deploy
        env:
          MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          GPG_PRIVATE_KEY: ${{ secrets.JAVA_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.JAVA_GPG_PASSPHRASE }}
