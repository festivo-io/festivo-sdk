name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure npm registry auth
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          scope: '@festivo-io'

      - name: Derive release version from tag
        id: set_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            ver=${GITHUB_REF#refs/tags/}
            ver=${ver#v}
          else
            ver=$(date +%s)
          fi
          echo "release_version=$ver" >> $GITHUB_OUTPUT
          echo "Derived release version: $ver"

      - name: Detect changed packages
        id: detect_changes
        run: |
          # Install nx CLI locally
          corepack enable || true
          corepack prepare pnpm@latest --activate || true
          pnpm -v >/dev/null 2>&1 || true
          # Ensure node modules available for nx if package.json exists
          if [ -f package.json ]; then
            pnpm install --frozen-lockfile || npm ci || true
          fi
          # Compute affected projects using nx; fall back to folder detection if nx fails
          git fetch --tags --quiet || true
          REF=${GITHUB_REF#refs/tags/}
          PREV_TAG=$(git describe --tags --abbrev=0 "${GITHUB_REF}^" 2>/dev/null || true)
          if command -v npx >/dev/null 2>&1; then
            echo "Trying nx print-affected"
            if [ -n "$PREV_TAG" ]; then
              AFFECTED=$(npx -y nx print-affected --base=$PREV_TAG --head=$REF --select=projects 2>/dev/null || true)
            else
              # If no previous tag, treat all projects as affected
              AFFECTED="js python php go"
            fi
          fi
          if [ -z "$AFFECTED" ]; then
            echo "nx detection failed; falling back to folder detection"
            if [ -n "$PREV_TAG" ]; then
              CHANGED=$(git diff --name-only "$PREV_TAG" "${GITHUB_REF}" || true)
            else
              CHANGED=$(git ls-tree -r --name-only HEAD || true)
            fi
            echo "$CHANGED" > changed.txt
            js=false; py=false; php=false; go=false
            if echo "$CHANGED" | grep -E '^js/' >/dev/null 2>&1; then js=true; fi
            if echo "$CHANGED" | grep -E '^python/' >/dev/null 2>&1; then py=true; fi
            if echo "$CHANGED" | grep -E '^php/' >/dev/null 2>&1; then php=true; fi
            if echo "$CHANGED" | grep -E '^go/' >/dev/null 2>&1; then go=true; fi
          else
            echo "Affected projects: $AFFECTED"
            js=false; py=false; php=false; go=false
            for p in $AFFECTED; do
              case "$p" in
                js) js=true ;;
                python|py) py=true ;;
                php) php=true ;;
                go) go=true ;;
              esac
            done
          fi
          echo "js_changed=$js" >> $GITHUB_OUTPUT
          echo "py_changed=$py" >> $GITHUB_OUTPUT
          echo "php_changed=$php" >> $GITHUB_OUTPUT
          echo "go_changed=$go" >> $GITHUB_OUTPUT
          echo -e "Changed files:\n$CHANGED"

      - name: Sync package files to release version (changed only)
        id: sync_versions
        run: |
          echo "Syncing package versions to $RELEASE_VERSION"
          # Update JS package.json if changed or FORCE_PUBLISH
          if [ "${{ steps.detect_changes.outputs.js_changed }}" = "true" ] || [ "${FORCE_PUBLISH}" = "true" ]; then
            node -e "const fs=require('fs'); const p=require('./js/package.json'); p.version=process.env.RELEASE_VERSION; fs.writeFileSync('./js/package.json', JSON.stringify(p,null,2));"
            echo "JS package.json updated"
          else
            echo "JS not changed — skip version bump"
          fi
          # Update Python pyproject.toml (Poetry)
          if [ "${{ steps.detect_changes.outputs.py_changed }}" = "true" ] || [ "${FORCE_PUBLISH}" = "true" ]; then
            sed -E -i.bak "s/^version\s*=\s*\"[^\"]*\"/version = \"${RELEASE_VERSION}\"/" python/pyproject.toml
            echo "Python pyproject.toml updated"
          else
            echo "Python not changed — skip version bump"
          fi
          # Update PHP composer.json
          if [ "${{ steps.detect_changes.outputs.php_changed }}" = "true" ] || [ "${FORCE_PUBLISH}" = "true" ]; then
            sed -E -i.bak "s/\"version\"\s*:\s*\"[^\"]*\"/\"version\": \"${RELEASE_VERSION}\"/" php/composer.json || true
            echo "PHP composer.json updated"
          else
            echo "PHP not changed — skip version bump"
          fi
          echo "Files updated"
        env:
          RELEASE_VERSION: ${{ steps.set_version.outputs.release_version }}
          FORCE_PUBLISH: ${{ env.FORCE_PUBLISH }}

      - name: Check npm for version
        id: npm_check
        if: ${{ steps.detect_changes.outputs.js_changed == 'true' || env.FORCE_PUBLISH == 'true' }}
        run: |
          cd js
          ver=$(node -p "require('./package.json').version")
          echo "Checking npm for @festivo-io/festivo-sdk@$ver"
          if npm view @festivo-io/festivo-sdk@$ver >/dev/null 2>&1; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "Version $ver is already published, will skip publish step."
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "Version $ver not found on npm, publish will proceed."
          fi

      - name: Publish JS package
        if: "startsWith(github.ref, 'refs/tags/v') && steps.npm_check.outputs.version_exists != 'true'"
        run: |
          cd js
          npm ci || npm install
          npm run build || true
          npm publish --access public --registry https://registry.npmjs.org
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Python and Poetry
        if: "startsWith(github.ref, 'refs/tags/v')"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        if: "startsWith(github.ref, 'refs/tags/v')"
        run: |
          python -m pip install --upgrade pip
          python -m pip install poetry

      - name: Check PyPI for version
        id: pypi_check
        if: ${{ steps.detect_changes.outputs.py_changed == 'true' || env.FORCE_PUBLISH == 'true' }}
        run: |
          cd python
          ver=$(sed -nE 's/^version *= *"([^"]+)"/\1/p' pyproject.toml | head -n1)
          name=$(sed -nE 's/^name *= *"([^"]+)"/\1/p' pyproject.toml | head -n1)
          echo "Checking PyPI for ${name} version ${ver}"
          if curl -sSf "https://pypi.org/pypi/${name}/json" >/dev/null 2>&1; then
            if curl -s "https://pypi.org/pypi/${name}/json" | python -c "import sys,json; d=json.load(sys.stdin); print('true' if '${ver}' in d.get('releases',{}) else 'false')" | grep -q true; then
              echo "version_exists=true" >> $GITHUB_OUTPUT
              echo "Version ${ver} already on PyPI"
            else
              echo "version_exists=false" >> $GITHUB_OUTPUT
              echo "Version ${ver} not on PyPI"
            fi
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "Package ${name} not found on PyPI"
          fi

      - name: Publish Python package
        if: "startsWith(github.ref, 'refs/tags/v') && (steps.detect_changes.outputs.py_changed == 'true' || env.FORCE_PUBLISH == 'true') && steps.pypi_check.outputs.version_exists != 'true'"
        run: |
          cd python
          poetry build
          poetry publish --username __token__ --password "$PYPI_API_TOKEN"
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Publish PHP / Packagist
        if: "startsWith(github.ref, 'refs/tags/v') && (steps.detect_changes.outputs.php_changed == 'true' || env.FORCE_PUBLISH == 'true')"
        run: echo "Packagist publishing is handled via Packagist/GitHub integration."

      - name: Notify Packagist (if credentials provided)
        if: "startsWith(github.ref, 'refs/tags/v') && (steps.detect_changes.outputs.php_changed == 'true' || env.FORCE_PUBLISH == 'true')"
        env:
          PACKAGIST_USER: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_API_TOKEN }}
        run: |
          if [ -z "$PACKAGIST_USER" ] || [ -z "$PACKAGIST_TOKEN" ]; then
            echo "Packagist credentials not provided; skipping notify."
            exit 0
          fi
          echo "Notifying Packagist to update package festivo-io/festivo-php"
          curl -sS -X POST "https://packagist.org/api/update-package?username=${PACKAGIST_USER}&apiToken=${PACKAGIST_TOKEN}" -d "package=festivo-io/festivo-php" || true

      - name: Go modules (tag published)
        run: echo "Go modules are available via git tags."
