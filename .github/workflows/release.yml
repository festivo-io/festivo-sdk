name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure npm registry auth
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          scope: '@festivo-io'

      - name: Derive release version from tag
        id: set_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            ver=${GITHUB_REF#refs/tags/}
            ver=${ver#v}
          else
            ver=$(date +%s)
          fi
          echo "release_version=$ver" >> $GITHUB_OUTPUT
          echo "Derived release version: $ver"

      - name: Sync package files to release version
        id: sync_versions
        run: |
          echo "Syncing package versions to $RELEASE_VERSION"
          # Update JS package.json
          node -e "const fs=require('fs'); const p=require('./js/package.json'); p.version=process.env.RELEASE_VERSION; fs.writeFileSync('./js/package.json', JSON.stringify(p,null,2));"
          # Update Python pyproject.toml (Poetry)
          sed -E -i.bak "s/^version\s*=\s*\"[^"]*\"/version = \"${RELEASE_VERSION}\"/" python/pyproject.toml
          # Update PHP composer.json
          sed -E -i.bak "s/\"version\"\s*:\s*\"[^"]*\"/\"version\": \"${RELEASE_VERSION}\"/" php/composer.json || true
          echo "Files updated"
        env:
          RELEASE_VERSION: ${{ steps.set_version.outputs.release_version }}

      - name: Check npm for version
        id: npm_check
        run: |
          cd js
          ver=$(node -p "require('./package.json').version")
          echo "Checking npm for @festivo-io/festivo-sdk@$ver"
          if npm view @festivo-io/festivo-sdk@$ver >/dev/null 2>&1; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "Version $ver is already published, will skip publish step."
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "Version $ver not found on npm, publish will proceed."
          fi

      - name: Publish JS package
        if: "startsWith(github.ref, 'refs/tags/v') && steps.npm_check.outputs.version_exists != 'true'"
        run: |
          cd js
          npm ci || npm install
          npm run build || true
          npm publish --access public --registry https://registry.npmjs.org
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Python and Poetry
        if: "startsWith(github.ref, 'refs/tags/v')"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        if: "startsWith(github.ref, 'refs/tags/v')"
        run: |
          python -m pip install --upgrade pip
          python -m pip install poetry

      - name: Check PyPI for version
        id: pypi_check
        run: |
          cd python
          ver=$(sed -nE 's/^version *= *"([^"]+)"/\1/p' pyproject.toml | head -n1)
          name=$(sed -nE 's/^name *= *"([^"]+)"/\1/p' pyproject.toml | head -n1)
          echo "Checking PyPI for ${name} version ${ver}"
          if curl -sSf "https://pypi.org/pypi/${name}/json" >/dev/null 2>&1; then
            if curl -s "https://pypi.org/pypi/${name}/json" | python -c "import sys,json; d=json.load(sys.stdin); print('true' if '${ver}' in d.get('releases',{}) else 'false')" | grep -q true; then
              echo "version_exists=true" >> $GITHUB_OUTPUT
              echo "Version ${ver} already on PyPI"
            else
              echo "version_exists=false" >> $GITHUB_OUTPUT
              echo "Version ${ver} not on PyPI"
            fi
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "Package ${name} not found on PyPI"
          fi

      - name: Publish Python package
        if: "startsWith(github.ref, 'refs/tags/v') && steps.pypi_check.outputs.version_exists != 'true'"
        run: |
          cd python
          poetry build
          poetry publish --username __token__ --password "$PYPI_API_TOKEN"
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Publish PHP / Packagist
        if: "startsWith(github.ref, 'refs/tags/v')"
        run: echo "Packagist publishing is handled via Packagist/GitHub integration."

      - name: Notify Packagist (if credentials provided)
        if: "startsWith(github.ref, 'refs/tags/v')"
        env:
          PACKAGIST_USER: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_API_TOKEN }}
        run: |
          if [ -z "$PACKAGIST_USER" ] || [ -z "$PACKAGIST_TOKEN" ]; then
            echo "Packagist credentials not provided; skipping notify."
            exit 0
          fi
          echo "Notifying Packagist to update package getfestivo/festivo-php"
          curl -sS -X POST "https://packagist.org/api/update-package?username=${PACKAGIST_USER}&apiToken=${PACKAGIST_TOKEN}" -d "package=getfestivo/festivo-php" || true

      - name: Go modules (tag published)
        run: echo "Go modules are available via git tags."
